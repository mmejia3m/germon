<!DOCTYPE html>  <html> <head>   <title>snmp.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="example.html">                 example.js               </a>                                           <a class="source" href="asn1ber.html">                 asn1ber.js               </a>                                           <a class="source" href="snmp.html">                 snmp.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               snmp.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>Introduction</h2>

<p>This is <code>node-snmp-native</code>, a native (Javascript) implementation of an SNMP
client library targeted at Node.js. It's MIT licensed and available at
https://github.com/calmh/node-snmp-native</p>

<p>(c) 2012 Jakob Borg, Nym Networks</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="s2">&quot;use strict&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Code</h2>

<p>This file implements a structure representing an SNMP message
and routines for converting to and from the network representation.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Define our external dependencies.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">dgram</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dgram&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">events</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>We also need our ASN.1 BER en-/decoding routines.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">asn1ber</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./asn1ber&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>Basic structures</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>A <code>VarBind</code> is the innermost structure, containing an OID-Value pair.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">VarBind</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>The <code>PDU</code> contains the SNMP request or response fields and a list of <code>VarBinds</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">PDU</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">pduTypes</span><span class="p">.</span><span class="nx">GetRequestPDU</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reqid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">errorIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">varbinds</span> <span class="o">=</span> <span class="p">[</span> <span class="k">new</span> <span class="nx">VarBind</span><span class="p">()</span> <span class="p">];</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The <code>Packet</code> contains the SNMP version and community and the <code>PDU</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">Packet</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">community</span> <span class="o">=</span> <span class="s1">&#39;public&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pdu</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDU</span><span class="p">();</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Allow consumers to create packet structures from scratch.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">Packet</span> <span class="o">=</span> <span class="nx">Packet</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>Private helper functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Concatenate several buffers to one.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">concatBuffers</span><span class="p">(</span><span class="nx">buffers</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">buf</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>First we calculate the total length,</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">buffers</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">total</span> <span class="o">+=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>then we allocate a new Buffer large enough to contain all data,</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">total</span><span class="p">);</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">buffers</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>finally we copy the data into the new larger buffer.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">buffer</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nx">cur</span> <span class="o">+=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">buf</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Clear a pending packet when it times out or is successfully received.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">clearRequest</span><span class="p">(</span><span class="nx">reqs</span><span class="p">,</span> <span class="nx">reqid</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="nx">reqs</span><span class="p">[</span><span class="nx">reqid</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">entry</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">timeout</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">delete</span> <span class="nx">reqs</span><span class="p">[</span><span class="nx">reqid</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Fix any OIDs in the 'oid' or 'oids' objects that are passed as strings.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">parseOidString</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid OID format&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">compact</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span> <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">parseOids</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">oid</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">oid</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">oid</span> <span class="o">=</span> <span class="nx">parseOidString</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">oid</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">oids</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">oids</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">oids</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">oid</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">oid</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">parseOidString</span><span class="p">(</span><span class="nx">oid</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">oid</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h2>Encode structure to ASN.1 BER</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Return an ASN.1 BER encoding of a Packet structure.
This is suitable for transmission on a UDP socket.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">encode</span><span class="p">(</span><span class="nx">pkt</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">version</span><span class="p">,</span> <span class="nx">community</span><span class="p">,</span> <span class="nx">reqid</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">erridx</span><span class="p">,</span> <span class="nx">vbs</span><span class="p">,</span> <span class="nx">pdu</span><span class="p">,</span> <span class="nx">message</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>We only support SNMPv2c, so enforce that version stamp.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">version</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Only SNMPv2c is supported.&#39;</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Encode the message header fields.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">version</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeInteger</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>
    <span class="nx">community</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeOctetString</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">community</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Encode the PDU header fields.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">reqid</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeInteger</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">reqid</span><span class="p">);</span>
    <span class="nx">err</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeInteger</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
    <span class="nx">erridx</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeInteger</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">errorIndex</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Encode the PDU varbinds.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">vbs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">vb</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">oid</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeOid</span><span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">oid</span><span class="p">),</span> <span class="nx">val</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">val</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeNull</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Integer</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">val</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeInteger</span><span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Unknown varbind type &quot;&#39;</span> <span class="o">+</span> <span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;&quot; in encoding.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">vbs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeSequence</span><span class="p">(</span><span class="nx">concatBuffers</span><span class="p">([</span><span class="nx">oid</span><span class="p">,</span> <span class="nx">val</span><span class="p">])));</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Concatenate all the varbinds together.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">vbs</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeSequence</span><span class="p">(</span><span class="nx">concatBuffers</span><span class="p">(</span><span class="nx">vbs</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Create the PDU by concatenating the inner fields and adding a request structure around it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">pdu</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeRequest</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">concatBuffers</span><span class="p">([</span><span class="nx">reqid</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">erridx</span><span class="p">,</span> <span class="nx">vbs</span><span class="p">]));</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Create the message by concatenating the header fields and the PDU.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">message</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeSequence</span><span class="p">(</span><span class="nx">concatBuffers</span><span class="p">([</span><span class="nx">version</span><span class="p">,</span> <span class="nx">community</span><span class="p">,</span> <span class="nx">pdu</span><span class="p">]));</span>

    <span class="k">return</span> <span class="nx">message</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">encode</span> <span class="o">=</span> <span class="nx">encode</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h2>Parse ASN.1 BER into a structure</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Parse an SNMP packet into its component fields.
We don't do a lot of validation so a malformed packet will probably just
make us blow up.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pkt</span><span class="p">,</span> <span class="nx">oid</span><span class="p">,</span> <span class="nx">bvb</span><span class="p">,</span> <span class="nx">vb</span><span class="p">,</span> <span class="nx">hdr</span><span class="p">;</span>

    <span class="nx">pkt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Packet</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>First we have a sequence marker (two bytes).
We don't care about those, so cut them off.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">hdr</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">typeAndLength</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Sequence</span><span class="p">,</span> <span class="nx">hdr</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">hdr</span><span class="p">.</span><span class="nx">header</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Then comes the version field (integer). Parse it and slice it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">pkt</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseInteger</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>We then get the community. Parse and slice.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">pkt</span><span class="p">.</span><span class="nx">community</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseOctetString</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Here's the PDU structure. We're interested in the type. Slice the rest.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">hdr</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">typeAndLength</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">hdr</span><span class="p">.</span><span class="nx">type</span> <span class="o">&gt;=</span> <span class="mh">0xA0</span><span class="p">);</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">hdr</span><span class="p">.</span><span class="nx">type</span> <span class="o">-</span> <span class="mh">0xA0</span><span class="p">;</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">hdr</span><span class="p">.</span><span class="nx">header</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>The request id field.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">reqid</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseInteger</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>The error field.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseInteger</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>The error index field.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">errorIndex</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseInteger</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Here's the varbind list. Not interested.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">hdr</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">typeAndLength</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Sequence</span><span class="p">,</span> <span class="nx">hdr</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">hdr</span><span class="p">.</span><span class="nx">header</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Now comes the varbinds. There might be many, so we loop for as long as we have data.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Sequence</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">vb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">VarBind</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Slice off the sequence header.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">hdr</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">typeAndLength</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Sequence</span><span class="p">,</span> <span class="nx">hdr</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
        <span class="nx">bvb</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">hdr</span><span class="p">.</span><span class="nx">header</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Parse and save the ObjectIdentifier.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">vb</span><span class="p">.</span><span class="nx">oid</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseOid</span><span class="p">(</span><span class="nx">bvb</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Parse the value. We use the type marker to figure out
what kind of value it is and call the appropriate parser
routine. For the SNMPv2c error types, we simply set the
value to a text representation of the error and leave handling
up to the user.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">bvb</span> <span class="o">=</span> <span class="nx">bvb</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">bvb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">bvb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Null</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Null type.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">vb</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">OctetString</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Octet string type.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">vb</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseOctetString</span><span class="p">(</span><span class="nx">bvb</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Integer</span> <span class="o">||</span>
                   <span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Counter</span> <span class="o">||</span>
                       <span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Counter64</span> <span class="o">||</span>
                           <span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">TimeTicks</span> <span class="o">||</span>
                               <span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Gauge</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Integer type and it's derivatives that behave in the same manner.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">vb</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseInteger</span><span class="p">(</span><span class="nx">bvb</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">ObjectIdentifier</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Object identifier type.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">vb</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseOid</span><span class="p">(</span><span class="nx">bvb</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">IpAddress</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>IP Address type.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">vb</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseArray</span><span class="p">(</span><span class="nx">bvb</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Opaque</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Opaque type. The 'parsing' here is very light; basically we return a
string representation of the raw bytes in hex.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">vb</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseOpaque</span><span class="p">(</span><span class="nx">bvb</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">EndOfMibView</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>End of MIB view error, returned when attempting to GetNext beyond the end
of the current view.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">vb</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;endOfMibView&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">NoSuchObject</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>No such object error, returned when attempting to Get/GetNext an OID that doesn't exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">vb</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;noSuchObject&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">NoSuchInstance</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>No such instance error, returned when attempting to Get/GetNext an instance
that doesn't exist in a given table.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">vb</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;noSuchInstance&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Something else that we can't handle, so throw an error.
The error will be caught and presented in a useful manner on stderr,
with a dump of the message causing it.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Unrecognized value type &#39;</span> <span class="o">+</span> <span class="nx">vb</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Take the raw octet string value and preseve it as a buffer and hex string.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">vb</span><span class="p">.</span><span class="nx">valueRaw</span> <span class="o">=</span> <span class="nx">bvb</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="nx">vb</span><span class="p">.</span><span class="nx">valueHex</span> <span class="o">=</span> <span class="nx">vb</span><span class="p">.</span><span class="nx">valueRaw</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Add the request id to the varbind (even though it doesn't really belong)
so that it will be availble to the end user.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">vb</span><span class="p">.</span><span class="nx">requestId</span> <span class="o">=</span> <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">reqid</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Push whatever we parsed to the varbind list.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">vb</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Go fetch the next varbind, if there seems to be any.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">hdr</span><span class="p">.</span><span class="nx">header</span> <span class="o">+</span> <span class="nx">hdr</span><span class="p">.</span><span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">hdr</span><span class="p">.</span><span class="nx">header</span> <span class="o">+</span> <span class="nx">hdr</span><span class="p">.</span><span class="nx">len</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">pkt</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <h2>Utility functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Compare two OIDs, returning -1, 0 or +1 depending on the relation between
oidA and oidB.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">compareOids</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">oidA</span><span class="p">,</span> <span class="nx">oidB</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">mlen</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>The undefined OID, if there is any, is deemed lesser.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">oidA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">oidB</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">oidA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">oidB</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Check each number part of the OIDs individually, and if there is any
position where one OID is larger than the other, return accordingly.
This will only check up to the minimum length of both OIDs.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">mlen</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">oidA</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">oidB</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">mlen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">oidA</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">oidB</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">oidB</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">oidA</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>If there is one OID that is longer than the other after the above comparison,
consider the shorter OID to be lesser.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">oidA</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">oidB</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">oidB</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">oidA</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>The OIDs are obviously equal.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <h2>Communication functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>This is called for when we receive a message.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">msgReceived</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">rinfo</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">now</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span> <span class="nx">pkt</span><span class="p">,</span> <span class="nx">entry</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Not sure why we sometimes receive an empty message.
As far as I'm concerned it shouldn't happen, but we'll ignore it
and if it's necessary a retransmission of the request will be
made later.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Parse the packet, or call the informative
parse error display if we fail.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">pkt</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parseError</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">msg</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>If this message's request id matches one we've sent,
cancel any outstanding timeout and call the registered
callback.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">entry</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">reqs</span><span class="p">[</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">reqid</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">entry</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">clearRequest</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">reqs</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">reqid</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">callback</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">vb</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">vb</span><span class="p">.</span><span class="nx">receiveStamp</span> <span class="o">=</span> <span class="nx">now</span><span class="p">;</span>
                <span class="nx">vb</span><span class="p">.</span><span class="nx">sendStamp</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">sendStamp</span><span class="p">;</span>
            <span class="p">});</span>

            <span class="nx">entry</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>This happens if we receive the response to a message we've already timed out
and removed the request entry for. Maybe we shouldn't even log the warning.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Calculate the approximate send time and how old the packet is.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">age</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x1fffff</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">reqid</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">age</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">age</span> <span class="o">+=</span> <span class="mh">0x200000</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Response with unknown request ID from &#39;</span> <span class="o">+</span> <span class="nx">rinfo</span><span class="p">.</span><span class="nx">address</span> <span class="o">+</span> <span class="s1">&#39;. Consider increasing timeouts (&#39;</span> <span class="o">+</span> <span class="nx">age</span> <span class="o">+</span> <span class="s1">&#39; ms old?).&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Default options for new sessions and operations.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">defaultOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="nx">port</span><span class="o">:</span> <span class="mi">161</span><span class="p">,</span>
    <span class="nx">community</span><span class="o">:</span> <span class="s1">&#39;public&#39;</span><span class="p">,</span>
    <span class="nx">family</span><span class="o">:</span> <span class="s1">&#39;udp4&#39;</span><span class="p">,</span>
    <span class="nx">timeouts</span><span class="o">:</span> <span class="p">[</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">5000</span> <span class="p">]</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>This creates a new SNMP session.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">Session</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">defaultOptions</span><span class="p">);</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">reqs</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">dgram</span><span class="p">.</span><span class="nx">createSocket</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">family</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">msgReceived</span><span class="p">,</span> <span class="nx">self</span><span class="p">));</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Remove the socket so we don't try to send a message on
it when it's closed.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">self</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Errors will be emitted here as well as on the callback to the send function.
We handle them there, so doing anything here is unnecessary.
But having no error handler trips up the test suite.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>We inherit from EventEmitter so that we can emit error events
on fatal errors.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Session</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">Session</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Generate a request ID. It's best kept within a signed 32 bit integer.
Uses the current time in ms, shifted left ten bits, plus a counter.
This gives us space for 1 transmit every microsecond and wraps every
~1000 seconds. This is OK since we only need to keep unique ID:s for in
flight packets and they should be safely timed out by then.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Session</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">requestId</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">now</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">prevTs</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">prevTs</span> <span class="o">=</span> <span class="nx">now</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">now</span> <span class="o">===</span> <span class="nx">self</span><span class="p">.</span><span class="nx">prevTs</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">counter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">counter</span> <span class="o">&gt;</span> <span class="mi">1023</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Request ID counter overflow. Adjust algorithm.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">prevTs</span> <span class="o">=</span> <span class="nx">now</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">((</span><span class="nx">now</span> <span class="o">&amp;</span> <span class="mh">0x1fffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">counter</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Display useful debugging information when a parse error occurs.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Session</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parseError</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">hex</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Display a friendly introductory text.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Woops! An error occurred while parsing an SNMP message. :(&#39;</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;To have this problem corrected, please report the information below verbatim&#39;</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;via email to snmp@nym.se or by creating a GitHub issue at&#39;</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;https://github.com/calmh/node-snmp-native/issues&#39;</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Thanks!&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Display the stack backtrace so we know where the exception happened.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Display the buffer data, nicely formatted so we can replicate the problem.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;\nMessage data:&#39;</span><span class="p">);</span>
    <span class="nx">hex</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">hex</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="nx">hex</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([0-9a-f]{2})/g</span><span class="p">,</span> <span class="s1">&#39;$1 &#39;</span><span class="p">));</span>
        <span class="nx">hex</span> <span class="o">=</span> <span class="nx">hex</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Let the exception bubble upwards.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Send a message. Can be used after manually constructing a correct Packet structure.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Session</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sendMsg</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pkt</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">buf</span><span class="p">,</span> <span class="nx">reqid</span><span class="p">,</span> <span class="nx">retrans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">);</span>

    <span class="nx">reqid</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">requestId</span><span class="p">();</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">reqid</span> <span class="o">=</span> <span class="nx">reqid</span><span class="p">;</span>

    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">encode</span><span class="p">(</span><span class="nx">pkt</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">transmit</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">socket</span> <span class="o">||</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">reqs</span><span class="p">[</span><span class="nx">reqid</span><span class="p">])</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>The socket has already been closed, perhaps due to an error that ocurred while a timeout
was scheduled. We can't do anything about it now.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">clearRequest</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">reqs</span><span class="p">,</span> <span class="nx">reqid</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Send the message.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">self</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">bytes</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">reqs</span><span class="p">[</span><span class="nx">reqid</span><span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">clearRequest</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">reqs</span><span class="p">,</span> <span class="nx">reqid</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">entry</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">entry</span><span class="p">.</span><span class="nx">sendStamp</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">timeouts</span><span class="p">[</span><span class="nx">retrans</span><span class="p">])</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Set timeout and record the timer so that we can (attempt to) cancel it when we receive the reply.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">entry</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">transmit</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">timeouts</span><span class="p">[</span><span class="nx">retrans</span><span class="p">]);</span>
                    <span class="nx">retrans</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">clearRequest</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">reqs</span><span class="p">,</span> <span class="nx">reqid</span><span class="p">);</span>
                    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Timeout&#39;</span><span class="p">));</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Register the callback to call when we receive a reply.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">reqs</span><span class="p">[</span><span class="nx">reqid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">callback</span><span class="o">:</span> <span class="nx">callback</span> <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Transmit the message.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">transmit</span><span class="p">();</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Shortcut to create a GetRequest and send it, while registering a callback.
Needs <code>options.oid</code> to be an OID in array form.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Session</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">;</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">);</span>
    <span class="nx">parseOids</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">oid</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[]);</span>
    <span class="p">}</span>

    <span class="nx">pkt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Packet</span><span class="p">();</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">community</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">community</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">oid</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">oid</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">sendMsg</span><span class="p">(</span><span class="nx">pkt</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Shortcut to create a SetRequest and send it, while registering a callback.
Needs <code>options.oid</code> to be an OID in array form, <code>options.value</code> to be an
integer and <code>options.type</code> to be asn1ber.T.Integer (2).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Session</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">;</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">);</span>
    <span class="nx">parseOids</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">oid</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Missing required option `oid`.&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Missing required option `value`.&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Missing required option `type`.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">pkt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Packet</span><span class="p">();</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">community</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">community</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">pduTypes</span><span class="p">.</span><span class="nx">SetRequestPDU</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">oid</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">oid</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">sendMsg</span><span class="p">(</span><span class="nx">pkt</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Shortcut to get all OIDs in the <code>options.oids</code> array sequentially. The
callback is called when the entire operation is completed.  If
options.abortOnError is truish, an error while getting any of the values
will cause the callback to be called with error status. When
<code>options.abortOnError</code> is falsish (the default), any errors will be ignored
and any successfully retrieved values sent to the callback.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Session</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getAll</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span> <span class="nx">abortOnError</span><span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>
    <span class="nx">parseOids</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">oids</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">oids</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[]);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">getOne</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">oid</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">vb</span><span class="p">;</span>

        <span class="nx">pkt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Packet</span><span class="p">();</span>
        <span class="nx">pkt</span><span class="p">.</span><span class="nx">community</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">community</span><span class="p">;</span>
        <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Push up to 16 varbinds in the same message.
The number 16 isn't really that magical, it's just a nice round
number that usually seems to fit withing a single packet and gets
accepted by the switches I've tested it on.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="nx">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">m</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span> <span class="o">&lt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">oids</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">vb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">VarBind</span><span class="p">();</span>
            <span class="nx">vb</span><span class="p">.</span><span class="nx">oid</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">oids</span><span class="p">[</span><span class="nx">c</span><span class="p">];</span>
            <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">vb</span><span class="p">);</span>
            <span class="nx">c</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">sendMsg</span><span class="p">(</span><span class="nx">pkt</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">varbinds</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">abortOnError</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">varbinds</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">results</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">varbinds</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&lt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">oids</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">getOne</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">results</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">getOne</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Shortcut to create a GetNextRequest and send it, while registering a callback.
Needs <code>options.oid</code> to be an OID in array form.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Session</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getNext</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">pkt</span><span class="p">;</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">);</span>
    <span class="nx">parseOids</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">oid</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[]);</span>
    <span class="p">}</span>

    <span class="nx">pkt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Packet</span><span class="p">();</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">community</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">community</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">oid</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">oid</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">sendMsg</span><span class="p">(</span><span class="nx">pkt</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Shortcut to get all entries below the specified OID.
The callback will be called once with the list of
varbinds that was collected, or with an error object.
Needs <code>options.oid</code> to be an OID in array form.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Session</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getSubtree</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">vbs</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">);</span>
    <span class="nx">parseOids</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">oid</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[]);</span>
    <span class="p">}</span>

    <span class="nx">options</span><span class="p">.</span><span class="nx">startOid</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">oid</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Helper to check whether <code>oid</code> in inside the tree rooted at
<code>root</code> or not.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">inTree</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">oid</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">oid</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">root</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">oid</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">root</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Helper to handle the result of getNext and call the user's callback
as appropriate. The callback will see one of the following patterns:
 - callback([an Error object], undefined) -- an error ocurred.
 - callback(null, [a Packet object]) -- data from under the tree.
 - callback(null, null) -- end of tree.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">result</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">varbinds</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">inTree</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">startOid</span><span class="p">,</span> <span class="nx">varbinds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">oid</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">varbinds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;endOfMibView&#39;</span> <span class="o">||</span> <span class="nx">varbinds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;noSuchObject&#39;</span> <span class="o">||</span> <span class="nx">varbinds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;noSuchInstance&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">vbs</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">vbs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">varbinds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                    <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">oid</span><span class="o">:</span> <span class="nx">varbinds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">oid</span> <span class="p">};</span>
                    <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">getNext</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">vbs</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">getNext</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Close the socket. Necessary to finish the event loop and exit the program.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Session</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 